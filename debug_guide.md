# 被动监听功能调试指南

## 问题症状

被动监听功能未正常工作，表现为：
- ❌ 被添加好友后没有自动抓取微信号
- ❌ 没有将微信号回写到飞书手机号字段
- ❌ 没有自动向新好友发送欢迎包

## 修复内容

### 1. 配置优化
- ✅ 移除硬编码关键词，使用配置文件中的 `MONITOR_KEYWORDS`
- ✅ 使用配置化的扫描间隔 `MONITOR_SCAN_INTERVAL`
- ✅ 减少扫描抖动时间，提高响应速度

### 2. 日志增强
- ✅ 添加详细的调试日志
- ✅ 显示关键词匹配过程
- ✅ 记录扫描次数和发现的好友数量
- ✅ 增加资料提取过程的日志

### 3. 调试工具
创建了 `src/debug/passive_monitor_debug.py` 调试工具

## 调试步骤

### 步骤1: 检查配置
确保配置文件中包含正确的设置：

```ini
[DEFAULT]
MONITOR_KEYWORDS = 已添加你为朋友,你现在可以给 ta 发送消息,你已添加了，以上是打招呼消息
MONITOR_MAX_CHATS = 6
MONITOR_SCAN_INTERVAL = 30
```

### 步骤2: 运行调试工具
```bash
python src/debug/passive_monitor_debug.py
```

选择功能 1 来测试被动监听功能。

### 步骤3: 查看日志
启动程序后，观察控制台日志，应该看到：

```
🔍 开始第 1 次被动扫描 (间隔: 30.0s)
开始被动扫描 6 个会话，关键词: ['已添加你为朋友', '你现在可以给 ta 发送消息']
🔍 尝试匹配关键词: 已添加你为朋友
✅ 精确匹配到关键词: 已添加你为朋友 (宽度: 120)
✅ 会话 1 匹配到关键词，准备提取资料
发现新的已添加好友: {'wechat_id': 'test123', 'nickname': '测试用户'}
[被动同步] test123 -> 已写入飞书手机号字段
```

### 步骤4: 常见问题排查

#### 问题1: 未发现新好友
**可能原因:**
- 会话列表中没有"已添加你为朋友"的系统消息
- 关键词配置不正确
- 微信窗口未正确激活

**解决方案:**
1. 确保有人刚刚添加你为好友
2. 检查微信会话列表中的系统消息内容
3. 更新 `MONITOR_KEYWORDS` 配置

#### 问题2: 关键词匹配失败
**可能原因:**
- 系统消息格式变化
- 控件定位问题

**解决方案:**
1. 使用调试工具查看实际匹配过程
2. 更新关键词列表，包含实际的消息文本
3. 调整搜索深度和超时时间

#### 问题3: 资料提取失败
**可能原因:**
- 微信版本兼容性问题
- 资料卡打开失败
- 字段提取逻辑问题

**解决方案:**
1. 检查微信版本是否支持
2. 手动打开资料卡，确认字段格式
3. 调整字段提取逻辑

#### 问题4: 飞书回写失败
**可能原因:**
- 飞书API配置错误
- 网络连接问题
- 权限不足

**解决方案:**
1. 运行调试工具测试飞书连接
2. 检查飞书应用配置
3. 确认网络代理设置

## 手动测试

### 1. 模拟添加好友
1. 让朋友添加你的微信
2. 等待系统消息出现
3. 手动查看是否包含配置的关键词

### 2. 检查日志级别
确保日志级别设置为DEBUG：
```python
logger.remove()
logger.add(sys.stdout, level="DEBUG")
```

### 3. 验证配置
检查配置是否正确加载：
```python
from src.config.settings import get_config
config = get_config()
print(f"关键词: {config.get('MONITOR_KEYWORDS')}")
```

## 常见关键词配置

根据微信版本不同，可能的关键词：

```ini
# 标准版本
MONITOR_KEYWORDS = 已添加你为朋友,你现在可以给 ta 发送消息

# 其他可能的变体
MONITOR_KEYWORDS = 已添加你为朋友,你现在可以给 ta 发送消息,你已添加了,现在可以开始聊天了,你们现在可以开始聊天了

# 英文版本
MONITOR_KEYWORDS = added you,start chatting now
```

## 性能优化

### 1. 调整扫描间隔
```ini
MONITOR_SCAN_INTERVAL = 20  # 减少到20秒提高响应速度
```

### 2. 调整扫描数量
```ini
MONITOR_MAX_CHATS = 8  # 增加到8个会话
```

### 3. 优化关键词
- 使用最准确的关键词
- 避免过于常见的词汇
- 定期更新关键词列表

## 联系支持

如果问题仍然存在：

1. 收集详细的日志信息
2. 记录具体的错误信息
3. 提供微信版本和操作系统信息
4. 描述重现问题的步骤

调试信息请包括：
- 配置文件内容（隐藏敏感信息）
- 完整的错误日志
- 微信系统消息的截图
# 门店数字化运营系统

<div align="center">

![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)
![Platform](https://img.shields.io/badge/platform-Windows-lightgrey.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

**自动化飞书 + 微信，智能获客与客户管理系统**

</div>

---

## 目录

- [功能特性](#功能特性)
- [系统架构](#系统架构)
- [快速开始](#快速开始)
- [详细配置](#详细配置)
- [业务流程](#业务流程)
- [开发指南](#开发指南)
- [常见问题](#常见问题)
- [更新日志](#更新日志)

---

## 功能特性

| 功能 | 描述 |
|:----:|:-----|
| 📋 **飞书自动轮询** | 自动获取 tenant_access_token，轮询任务表并实时更新处理状态 |
| 🔗 **Wiki 链接转换** | 智能识别并转换 Wiki 链接为 Bitable Base Token |
| 👥 **微信主动添加** | 自动搜索手机号、发送好友申请，支持自定义验证语 |
| 🎁 **首次欢迎包** | 加好友成功后自动推送门店指引（支持图文混排） |
| 👀 **新好友监控** | 自动扫描「通讯录 → 新的好友 → 等待验证」，获取微信号写入飞书 |
| 🖥️ **Flet 管理界面** | 实时日志查看、状态监控、参数动态调节 |
| 🔔 **远程告警** | ERROR/CRITICAL 日志通过飞书 webhook 实时推送 |
| 🚀 **热更新启动器** | 自动下载更新包，无需手动替换 |

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         门店数字化运营系统                              │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        ▼                          ▼                          ▼
┌──────────────┐          ┌──────────────┐          ┌──────────────┐
│  飞书平台     │          │   微信 PC     │          │   控制台      │
│  (数据源)    │◄─────►│   (自动化)    │          │   (可视化)    │
└──────────────┘          └──────────────┘          └──────────────┘
        │                          │                          │
        └──────────────────────────┼──────────────────────────┘
                                   ▼
                        ┌──────────────┐
                        │ TaskEngine   │
                        │  (双线程)    │
                        └──────────────┘
```

### 代码目录结构

```
store_system_source/
├── src/
│   ├── main.py                 # 程序入口
│   ├── config/                 # 配置层
│   │   ├── settings.py         # 配置读取与持久化
│   │   ├── logger.py           # 日志 & 飞书 webhook
│   │   └── network.py          # 网络配置与 SSL 代理
│   ├── core/                   # 业务核心
│   │   ├── system.py           # DPI、自检、环境检测
│   │   └── engine.py           # TaskEngine（双线程任务引擎）
│   ├── services/               # 外部服务
│   │   ├── feishu.py           # 飞书多维表格 API 客户端
│   │   ├── wechat.py           # 微信 RPA 主类
│   │   ├── wechat_ui.py        # UI 操作基类
│   │   ├── wechat_profile.py    # 资料卡操作
│   │   ├── wechat_chat.py      # 聊天消息操作
│   │   └── wechat_contacts.py  # 通讯录操作
│   ├── ui/                     # 用户界面
│   └── utils/                  # 工具脚本
│       └── table_inspector.py   # 飞书表结构辅助
├── launcher.py                # 热更新启动器
├── ui_probe.py                # UI 控件调试工具
├── requirements.txt            # Python 依赖
├── .env.example               # 环境变量示例
├── config.ini                # 运行后生成的配置
├── README.md                 # 项目文档
├── CLAUDE.md                # AI 开发指导
└── RELEASE_GUIDE.md          # 发布与回滚指南
```

### 双线程并发模型

```
┌─────────────────────────────────────────────────────────────────┐
│                        TaskEngine                         │
└─────────────────────────────────────────────────────────────────┘
                         │
        ┌────────────────┴────────────────┐
        ▼                                  ▼
┌─────────────────┐              ┌─────────────────┐
│ task-engine    │              │ passive-monitor │
│ (主动添加线程)   │              │  (被动监控线程)   │
└─────────────────┘              └─────────────────┘
        │                                  │
        ▼                                  ▼
 每 5 秒轮询                    每 30 秒扫描
 "待添加"任务                    "新的好友"列表
        │                                  │
        └────────────────┬────────────────┘
                         ▼
                   wechat_lock
              (微信 UI 操作互斥锁)
```

---

## 快速开始

### 1️⃣ 安装依赖

```bash
pip install -r requirements.txt
```

### 2️⃣ 运行程序

```bash
# 开发模式
python -m src.main

# 或使用启动器（支持热更新）
python launcher.py
```

### 3️⃣ 首次配置

首次运行会自动弹出配置窗口，需要填写以下信息：

| 配置项 | 说明 | 示例 |
|:------|:-----|:-----|
| 飞书 App ID | 飞书应用唯一标识 | `cli_xxxxxxxx` |
| 飞书 App Secret | 飞书应用密钥 | `xxxxxxxxxxxxxxxx` |
| 客户表链接 | 客户档案表格链接（支持 Wiki 链接） | `https://...` |
| 任务表链接 | 待处理任务表格链接（可选） | `https://...` |
| 微信启动路径 | PC 微信可执行文件路径 | `C:\Program Files\Tencent\WeChat\WeChat.exe` |

---

## 详细配置

### 飞书配置

#### Wiki 链接支持

系统自动识别并转换以下格式链接：

```
https://ai.feishu.cn/wiki/<wiki_token>?table=tblxxx
       ↓ 自动转换为
https://open.feishu.cn/open-apis/bitable/v1/apps/<app_token>/tables/<table_id>/records
```

#### 必需字段

客户表需包含以下字段：

| 字段名称 | 字段类型 | 说明 |
|:---------|:---------|:-----|
| 手机号 | 手机号 | 客户联系方式 |
| 姓名 | 文本 | 客户姓名 |
| 微信绑定状态 | 单选 | 状态：待添加 / 已申请 / 已绑定 / 未找到 |
| 微信号 | 文本 | 微信号（自动填充） |
| 昵称 | 文本 | 微信昵称（自动填充） |
| 微信备注 | 文本 | 备注信息（可选） |

### 欢迎包配置

#### JSON 格式（推荐）

```json
[
  {
    "type": "text",
    "content": "您好！感谢添加好友，欢迎来到我们的门店！"
  },
  {
    "type": "image",
    "path": "D:\\guide\\welcome.png"
  },
  {
    "type": "text",
    "content": "我们的营业时间：\n周一至周五 09:00-21:00\n周六至周日 10:00-22:00"
  },
  {
    "type": "link",
    "url": "https://example.com",
    "title": "点击查看更多详情"
  }
]
```

#### 旧版格式（向后兼容）

```ini
WELCOME_ENABLED=1
WELCOME_TEXT=您好！欢迎来到我们的门店！
WELCOME_IMAGE_PATHS=D:\guide\a.png|D:\guide\b.jpg
```

### 网络配置

支持 VPN/代理环境自动检测，可通过环境变量或配置文件设置：

| 变量 | 说明 | 默认值 |
|:-----|:-----|:-------|
| `NETWORK_PROXY` | 手动代理地址 | 空 |
| `NETWORK_VERIFY_SSL` | 是否验证 SSL 证书 | `1` (启用) |
| `NETWORK_TIMEOUT` | 请求超时时间（秒） | `15` |
| `NETWORK_USE_SYSTEM_PROXY` | 使用系统代理 | `0` (禁用) |

### 运行参数

可在 Flet 界面中实时调节：

| 参数 | 说明 | 范围 | 默认值 |
|:-----|:-----|:-----|:-------|
| 监控频率 | 新好友扫描间隔 | 5-300 秒 | 30 秒 |
| 飞书轮询频率 | 任务表轮询间隔 | 3-60 秒 | 5 秒 |
| 扫描抖动 | 随机延迟范围 | 0-30 秒 | 5 秒 |
| 欢迎包开关 | 是否自动发送欢迎 | 开关 | 开启 |

---

## 业务流程

### 主动添加好友流程

```
┌─────────────┐
│ 飞书任务表   │
│ (待添加状态) │
└──────┬──────┘
       │
       ▼
┌─────────────────────────┐
│ 微信搜索手机号          │
│ 打开资料卡            │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────────┐
│ 检测好友关系          │
└──────┬──────────────┘
       │
   ┌───┴───┐
   ▼       ▼       ▼
┌─────┐ ┌─────┐ ┌─────┐
│已好友│ │陌生人│ │未找到│
└──┬──┘ └──┬──┘ └──┬──┘
   │        │        │
   ▼        ▼        ▼
发送    点击添加    更新为
welcome → 通讯录   →  "未找到"
   │        │
   ▼        ▼
更新为    更新为
"已绑定"  "已申请"
```

### 被动监控流程

```
┌──────────────────────────────────────────────────────────────┐
│                   被动监控线程 (每 30 秒)                    │
└──────────────────────────────────────────────────────────────┘
                         │
                         ▼
              ┌───────────────────┐
              │ 点击「通讯录」Tab   │
              └─────────┬─────────┘
                        │
                        ▼
              ┌───────────────────┐
              │ 点击「新的朋友」    │
              └─────────┬─────────┘
                        │
          ┌───────────┴───────────┐
          ▼                       ▼
   ┌─────────────┐        ┌─────────────┐
   │  已添加列表   │        │ 等待验证列表  │
   │ (第一阶段)   │        │  (第二阶段)   │
   └──────┬──────┘        └──────┬──────┘
          │                       │
          ▼                       ▼
   ┌─────────────┐        ┌─────────────┐
   │ 点击列表项   │        │ 点击列表项   │
   └──────┬──────┘        └──────┬──────┘
          │                       │
          ▼                       ▼
   ┌─────────────┐        ┌─────────────┐
   │ 获取微信号   │        │ 点击前往验证  │
   └──────┬──────┘        └──────┬──────┘
          │                       │
          ▼                       ▼
   ┌─────────────┐        ┌─────────────┐
   │ 写入飞书状态 │        │ 点击确定按钮   │
   │ 已绑定 + 微信号│       └──────┬──────┘
   └──────┬──────┘               │
          │                       ▼
          │              ┌─────────────┐
          │              │ 获取微信号   │
          │              └──────┬──────┘
          │                     │
          │                     ▼
          │              ┌─────────────┐
          │              │ 写入飞书状态 │
          │              │ 已绑定 + 微信号│
          │              └──────┬──────┘
          │                     │
          └──────────┬──────────┘
                     ▼
           ┌───────────────────┐
           │ 发送欢迎包       │
           │ (图文混排支持)    │
           └──────┬──────────┘
                  │
                  ▼
           ┌───────────────────┐
           │ 删除新好友记录    │
           │ (自动去重)       │
           └───────────────────┘
```

### 状态流转图

```
                    ┌─────────┐
                    │  待添加   │
                    └────┬────┘
                         │
           ┌─────────────┴─────────────┐
           │                           │
           ▼                           ▼
    ┌─────────┐                  ┌─────────┐
    │ 搜索成功  │                  │ 搜索失败  │
    └────┬────┘                  └────┬────┘
         │                              │
    ┌────┴────┐                      │
    │         │                      │
    ▼         ▼                      ▼
┌─────┐  ┌─────┐              ┌─────────┐
│已好友│  │陌生人│              │  未找到  │
└──┬──┘  └──┬──┘              └────┬────┘
   │         │                       │
   │         │                       │
   │         │                       │
   │         │                       │
   ▼         │                       ▼
发送       发送                  更新为
welcome   好友申请                "未找到"
   │         │
   │         │
   │         ▼
   │    ┌─────────┐
   │    │  已申请   │
   │    └────┬────┘
   │         │
   │         │ 被动通过验证
   │         │
   │         ▼
   │    ┌─────────┐
   │    │  已绑定   │
   │    └────┬────┘
   │         │
   └────┬────┘
        │
        ▼
   ┌─────────┐
   │  已绑定   │
   └─────────┘
```

---

## 开发指南

### 常用命令

```bash
# 运行主程序
python -m src.main

# 运行启动器
python launcher.py

# 检查飞书表格结构
python -m src.utils.table_inspector

# UI 控件调试（鼠标悬停3秒输出控件信息）
python ui_probe.py

# 打包成 exe
pyinstaller --onefile --name main_bot --clean src/main.py

# 使用 specs 文件打包
pyinstaller main_bot.spec
```

### 代码风格

- 使用类型注解 (Type Hints)
- 日志使用 loguru，使用中文消息
- 异常处理：记录日志后继续或抛出

### Git 提交规范

```
feat: 新功能
fix: 修复 bug
refactor: 重构
docs: 文档更新
chore: 其他修改
```

### 微信 RPA 控件定位

| 功能 | 控件类型 | Name | ClassName |
|:----|:---------|:-----|:---------|
| 通讯录 Tab | ButtonControl | 通讯录 | mmui::XTabBarItem |
| 新的朋友入口 | ListItemControl | 新的朋友 | mmui::ContactsCellGroupView |
| 待验证列表项 | ListItemControl | *等待验证 | mmui::XTableCell |
| 前往验证按钮 | ButtonControl | 前往验证 | mmui::XOutlineButton |
| 确定按钮 | ButtonControl | 确定 | mmui::XOutlineButton |
| 微信号 | TextControl | 微信号 | mmui::ContactProfileTextView |

---

## 常见问题

### 问题：微信 RPA 无响应

**排查步骤：**
1. 确保微信窗口在前台可见
2. 检查是否有弹窗遮挡
3. 查看 DEBUG 日志中的控件查找信息
4. 尝试配置 `WECHAT_EXEC_PATH`

---

### 问题：飞书 API 错误

**排查步骤：**
1. 检查网络连接
2. 验证 App ID 和 Secret 是否正确
3. 确认应用权限配置
4. 检查是否需要代理配置

---

### 问题：打包时 PermissionError

**解决方法：**
1. 关闭杀毒软件
2. 结束旧进程
3. 以管理员身份运行

---

### 问题：更新后仍是旧版本

**解决方法：**
1. 删除 `local_version.txt` 文件
2. 重新运行启动器
3. 手动下载最新版本覆盖

---

### 问题：新好友监控无响应

**排查步骤：**
1. 确保微信已登录
2. 检查是否有新的好友
3. 查看日志中的控件定位信息
4. 尝试调整监控频率

---

## 更新日志

### 最新版本

- ✅ 优化被动监控两阶段处理逻辑
- ✅ 新增微信 RPA 模块化设计
- ✅ 改进飞书 Upsert 搜索优先级
- ✅ 新增网络环境自动检测
- ✅ 修复线程资源泄漏问题

---

## 相关文档

- 📖 [CLAUDE.md](./CLAUDE.md) - AI 开发指导文档
- 📘 [RELEASE_GUIDE.md](./RELEASE_GUIDE.md) - 发布与回滚指南
- 📄 [.env.example](./.env.example) - 环境变量示例

---

## 许可证

MIT License

---

<div align="center">

**如有问题或建议，欢迎提交 Issue 或 Pull Request**

Made with ❤️ by [yeekii6699](https://github.com/yeekii6699-prog)

</div>
